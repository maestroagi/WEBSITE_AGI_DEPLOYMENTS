# Notificaci√≥n por Telegram cuando hay push/merge a main en WEBSITE_AGI_DEPLOYMENTS.
# Requiere en este repo: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí
#   TELEGRAM_NOTIFY_BOT_TOKEN, TELEGRAM_NOTIFY_CHAT_ID (mismos valores que en openclaw-workspace si quieres el mismo chat).

name: Notify push to Telegram

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout para obtener archivos del commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enviar notificaci√≥n a Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_NOTIFY_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Secrets no configurados: a√±ade TELEGRAM_NOTIFY_BOT_TOKEN y TELEGRAM_NOTIFY_CHAT_ID en Settings ‚Üí Secrets and variables ‚Üí Actions."
            exit 0
          fi
          SHORT_SHA="${SHA:0:7}"
          COMMIT_MSG_ONE=$(echo "$COMMIT_MSG" | head -1 | sed 's/"/\\"/g; s/\\/\\\\/g')
          COMMIT_URL="https://github.com/${REPO}/commit/${SHA}"
          SITE_URL="https://maestroagi.github.io/WEBSITE_AGI_DEPLOYMENTS/"
          TS_FMT=$(echo "$COMMIT_TIMESTAMP" | sed 's/T/ /; s/\.[0-9]*Z/ UTC/')
          FILES=$(git show --name-only --format="" "$SHA" 2>/dev/null | head -15)
          STAT=$(git show --shortstat --format="" "$SHA" 2>/dev/null || echo "")
          FILES_COMPACT=$(echo "$FILES" | head -8 | tr '\n' ', ' | sed 's/, $//')
          BODY="üåê Sitio actualizado ‚Äî ${COMMIT_AUTHOR}
${REPO} ¬∑ ${SHORT_SHA} ¬∑ ${TS_FMT}
${COMMIT_MSG_ONE}"
          [ -n "$STAT" ] && BODY="$BODY
${STAT}"
          [ -n "$FILES_COMPACT" ] && BODY="$BODY
üìÑ ${FILES_COMPACT}"
          BODY="$BODY
üîó $COMMIT_URL
üìÑ $SITE_URL"
          TEXT_JSON=$(echo "$BODY" | jq -Rs .)
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": ${TEXT_JSON}, \"disable_web_page_preview\": true}"
